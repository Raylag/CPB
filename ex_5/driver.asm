.MODEL FLAT
.STACK 100h

.data
; Данные не используются

.code
main PROC
    ; ---------- Шаг 1: инициализация системы (подача 10В на мотор) ----------
    mov  dx, 93          ; код напряжения для 10В (десятичное 93)
    mov  ax, dx
    or   ax, 4000h       ; установить бит 14 (команда для ЦАП)
    out  2h, ax          ; отправить на порт ЦАП

main_loop:
    ; ---------- Шаг 2: ожидание сигнала от компаратора ----------
wait_comp:
    ; отправка кода на мотор
    mov  ax, dx
    or   ax, 4000h       ; бит 14 = 1 (команда для ЦАП)
    out  2h, ax
    ; читаем значение от компаратора
    in   ax, 1h
    test ax, 8000h       ; проверяем бит 15 (сигнал готов)
    jnz  comp_ok         ; если бит 15 = 1, переход к шагу 3
    ; иначе сбрасываем напряжение на 10В и повторяем
    mov  dx, 93
    jmp  wait_comp

comp_ok:
    ; ---------- Шаг 3: получение двух значений от измерительной системы и их усреднение ----------
    ; ---- первое измерение (биты 15 и 14) ----
    mov  ax, dx
    or   ax, 0C000h      ; биты 15 и 14 = 1
    out  2h, ax
wait_meas1:
    in   ax, 1h
    test ax, 4000h       ; ждём бит 14 = 1 (данные готовы)
    jz   wait_meas1
    and  ax, 0FFFh       ; оставляем только младшие 12 бит (0-11)
    mov  bx, ax          ; сохраняем в bx

    ; ---- второе измерение (биты 14 и 13) ----
    mov  ax, dx
    or   ax, 6000h       ; биты 14 и 13 = 1 (4000h + 2000h)
    out  2h, ax
wait_meas2:
    in   ax, 1h
    test ax, 4000h       ; ждём бит 14 = 1
    jz   wait_meas2
    and  ax, 0FFFh       ; только младшие 12 бит

    ; ---- усреднение ----
    add  ax, bx          ; ax = первое + второе
    shr  ax, 1           ; деление на 2 (сдвиг вправо) – получаем среднее
    ; Если по заданию нужен сдвиг влево (умножение на 2), замените на shl ax, 1

    ; ---------- Шаг 4: определение необходимого количества оборотов ----------
    cmp  ax, 1000
    jl   step5           ; если <1000, оставляем текущее dx без изменений
    cmp  ax, 1450
    jl   set558
    cmp  ax, 2200
    jl   set744
    ; >= 2200
    mov  dx, 930
    jmp  step5
set558:
    mov  dx, 558
    jmp  step5
set744:
    mov  dx, 744

step5:
    ; ---------- Шаг 5: отправка кода напряжения на ЦАП ----------
    mov  ax, dx
    or   ax, 4000h       ; бит 14 = 1 (команда для ЦАП)
    out  2h, ax

    ; ---------- Шаг 6: задержка ----------
    call DELAY

    ; ---------- Шаг 7: переход к шагу 2 ----------
    jmp  main_loop

main ENDP

; Процедура задержки (как в примере)
DELAY PROC
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    mov bx, 2053         ; 4 такта
L1:
    mov cx, 6191         ; 4 такта
L2:
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    loop L2              ; 17/5 тактов
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    nop                  ; 3 такта
    ; команды для поддержания работы мотора (эквивалентны 5 nop)
    mov  ax, dx          ; 3 такта
    or   ax, 4000h       ; 4 такта
    out  2h, ax          ; 8 тактов
    dec bx               ; 3 такта
    jnz L1               ; 16/4 тактов
    ret                  ; 20 тактов
DELAY ENDP

END main